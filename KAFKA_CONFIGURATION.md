# **üì® –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é Kafka Message Broker**

–í —ç—Ç–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ –æ–ø–∏—Å–∞–Ω –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Apache Kafka –¥–ª—è –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã Titanic, —Ä–µ—à–µ–Ω–∏–µ —Ç–∏–ø–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º —Å Docker –Ω–∞ Windows –∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–º–µ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.

## **üèóÔ∏è 1\. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (Docker Compose)**

–î–ª—è —Ä–∞–±–æ—Ç—ã Kafka –Ω–∞–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–≤–∞ —Å–µ—Ä–≤–∏—Å–∞: **Zookeeper** (–¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏) –∏ —Å–∞–º–∞ **Kafka**.

### **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `docker-compose.yml`**

–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã –≤ –≤–∞—à `docker-compose.yml`. **–í–∞–∂–Ω–æ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—Ä–∞–∑—ã `confluentinc`, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –Ω–∞–∏–±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã –∏ –ø—Ä–æ—Å—Ç—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

```
  # ... (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã api_gateway, auth_service –∏ —Ç.–¥.)

  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - titanic-network

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ —Å–Ω–∞—Ä—É–∂–∏ (localhost) –∏ –≤–Ω—É—Ç—Ä–∏ Docker —Å–µ—Ç–∏
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      # –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –±—Ä–æ–∫–µ—Ä–∞: –æ—Ç–∫–ª—é—á–∞–µ–º —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - titanic-network
```

### **–ó–∞–ø—É—Å–∫**

```
# –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–µ—Å–ª–∏ –±—ã–ª–∏)
docker-compose down -v

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
docker-compose up -d
```

## **üõ†Ô∏è 2\. –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å Docker –Ω–∞ Windows**

–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Docker –Ω–∞ Windows —á–∞—Å—Ç–æ –≤–æ–∑–Ω–∏–∫–∞—é—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã. –í–æ—Ç –∏—Ö —Ä–µ—à–µ–Ω–∏—è:

### **‚ùå –û—à–∏–±–∫–∞: "Access is denied"**

**–ü—Ä–∏—á–∏–Ω–∞:** –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Windows –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Docker Engine. **–†–µ—à–µ–Ω–∏–µ:**

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Ä–º–∏–Ω–∞–ª (PowerShell/CMD) **–æ—Ç –∏–º–µ–Ω–∏ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞**.  
2. –ò–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É `docker-users` (—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞).

### **‚ùå –û—à–∏–±–∫–∞: "Kafka container exited with code 1"**

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å –æ–±—Ä–∞–∑–æ–º. –ù–∞–ø—Ä–∏–º–µ—Ä, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö `KAFKA_CFG_...` (Bitnami) —Å –æ–±—Ä–∞–∑–æ–º `confluentinc`. **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ 1, –æ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ –¥–ª—è –æ–±—Ä–∞–∑–æ–≤ Confluent.

### **‚ùå –û—à–∏–±–∫–∞: "failed to resolve reference"**

**–ü—Ä–∏—á–∏–Ω–∞:** Docker –Ω–µ –º–æ–∂–µ—Ç —Å–∫–∞—á–∞—Ç—å –æ–±—Ä–∞–∑ –∏–∑\-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å —Å–µ—Ç—å—é –∏–ª–∏ VPN. **–†–µ—à–µ–Ω–∏–µ:** –í—ã–ø–æ–ª–Ω–∏—Ç–µ `docker pull confluentinc/cp-kafka:7.4.0` –≤—Ä—É—á–Ω—É—é.

## **üß™ 3\. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤ (Playwright \+ KafkaJS)**

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É `kafkajs`.

### **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**

```
cd titanic-tests
npm install kafkajs
```

### **–°–æ–∑–¥–∞–Ω–∏–µ Kafka Helper (`src/utils/kafka.helper.ts`)**

–≠—Ç–æ—Ç –∫–ª–∞—Å—Å –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–ø–∏–∫–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**

* **Admin Client:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —è–≤–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–ø–∏–∫–∞ –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–æ–º (`ensureTopicExists`). –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ "Leader Not Available".  
* **–¢–∞–π–º–∞—É—Ç—ã:** –£–≤–µ–ª–∏—á–µ–Ω—ã –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≤ Docker Desktop.

### **–ù–∞–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞ (`tests/advanced/kafka-broker.spec.ts`)**

–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–∑–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π "Event-Driven Architecture":

1. –¢–µ—Å—Ç –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Ç–æ–ø–∏–∫ `titanic-events`.  
2. –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ (–∫–∞–∫ –±—É–¥—Ç–æ —ç—Ç–æ —Å–¥–µ–ª–∞–ª –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å).  
3. –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å —Å `afterAll`:** –ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∑–∞–≤–∏—Å–∞–Ω–∏—è —Ç–µ—Å—Ç–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –æ—Ç Kafka (—á–∞—Å—Ç–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ Windows), –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º `Promise.race`:

```
// –ï—Å–ª–∏ disconnect() –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ 5 —Å–µ–∫—É–Ω–¥, –º—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º —Ç–µ—Å—Ç
await Promise.race([
    kafka.disconnect(),
    new Promise(resolve => setTimeout(resolve, 5000))
]);
```

## **üöÄ 4\. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞**

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Kafka –∑–∞–ø—É—â–µ–Ω–∞ (`docker ps` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `kafka`), –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```
npx playwright test tests/advanced/kafka-broker.spec.ts
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

```
‚úÖ Connected to Kafka Broker
[Kafka] Sent to titanic-events: { ... }
[Kafka] Received from titanic-events: { ... }
  1 passed
```

–¢–µ–ø–µ—Ä—å –≤–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞—Å—Ç–æ—è—â–∏—Ö —Å–æ–±—ã—Ç–∏–π–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (Phase 3)\! üéâ

